pipeline {
    environment {
        registry = "abdelaliabia99/tp2"  
        registryCredential = '2951d918-030d-42a7-9ef6-4e6d5306eff0'  
        dockerImage = ''  
    }
    agent any  
    stages {
        stage('Cloning Git') {  
            steps {
                git 'https://github.com/Abdelali-Moutawassit/tp2_devops'  // Clonage du dépôt Git
            }
        }
        stage('Building image') {  // Construction de l'image Docker
            steps {
                script {
                    dockerImage = docker.build registry + ":$BUILD_NUMBER"  // Création de l'image avec le numéro de build
                }
            }
        }
        stage('Test image') {  // Test de l'image
            steps {
                script {
                    echo "Tests passed"  // Simule le succès des tests
                }
            }
        }
        stage('Publish Image') {  // Publication de l'image sur DockerHub
            steps {
                script {
                    docker.withRegistry('', registryCredential) {  
                        dockerImage.push()  // Pousse l'image vers DockerHub
                    }
                }
            }
        }
        stage('Deploy image') {  // Déploiement de l'image
            steps {
                script {
                    sh "docker run -d --name tp2_app -p 8080:80 ${registry}:$BUILD_NUMBER"  // Déploiement du conteneur
                }
            }
        }
    }
}
